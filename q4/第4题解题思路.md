### 第4题解题思路（基于实现与运行结果）

本题在一个异构蜂窝网络（1 个宏基站 MBS + 3 个小基站 SBS）中，同时联合优化三类决策：
- 接入决策：每个用户接入到哪个基站（0 表示 MBS，1-3 表示各 SBS）
- 资源分配：各基站将离散资源块分配给各用户
- 功率控制：各基站的发射功率（dBm）

实现与数据均见 `q4/q4_solution.py` 与 `data_4/`。算法每 100ms 决策一次，共 0–900ms 十个时隙；结果写入 `q4/results.csv`。

### 问题建模与数据

- 基站与资源：MBS 提供 100 个 RB，SBS 各 50 个 RB；功率范围约束：MBS ∈ [10, 40] dBm，SBS ∈ [10, 30] dBm。
- 用户规模与类型：共 70 名用户，类型映射为 URLLC 10 名、eMBB 20 名、mMTC 40 名，分别对应严格时延/高吞吐/海量连接需求。
- 信道数据：使用附件 4 的大/小尺度衰落表（MBS 与每个 SBS 各自一份）。在 `calculate_channel_gain` 中，接收功率按
  rx_power = 10^((P_tx_dBm - L_large)/10) × (h_small)^2
  计算，其中 `L_large` 为大尺度衰落（dB），`h_small` 为瑞利小尺度增益幅度。
- 速率与噪声：单 RB 带宽 b = 360 kHz，噪声系数 NF = 7，白噪声密度按 N0 = −174 + 10·log10(b) + NF（dBm/Hz）计；总噪声功率与占用 RB 数线性相关。
- 干扰建模：若其他基站也对同一用户在该时隙分配了资源，则其信号视为干扰；引入干扰协调因子，当他站信号过强时按 0.3 衰减其对该用户的干扰影响。

### QoS 定义与目标

针对不同业务类型按 SLA 评估 QoS：
- URLLC：时延 ≤ 1ms 记 0.95，否则 −5
- eMBB：若时延 ≤ 4ms 且速率 ≥ 50 Mbps 记 1；若时延合格但速率不足，按 rate/50Mbps 计分；否则 −3
- mMTC：时延 ≤ 10ms 时按分配 RB 数比例记分（RB/10），否则 −1

时延估计来自任务流队列长度，并结合基站处理能力与用户类型系数加权。总体优化目标为所有用户 QoS 的加权和（URLLC 权重 1.5，eMBB 权重 1.2，mMTC 权重 1.0），用于指导接入/资源/功率的联合优化；报告阶段则分别统计各类型的平均 QoS 与总 QoS（不加权求和）。

### 优化策略与实现要点

1) 接入与资源：遗传算法（GA）
- 个体编码：`(access_decision, resource_allocation)`，前者为用户→基站映射，后者为基站×用户的 RB 矩阵。
- 初始化：随机接入；按综合优先级动态分配 RB。优先级为 队列长度 × 业务权重 ÷ 信道增益，兼顾需求紧迫性与链路条件。
- 资源约束：MBS≤100、各 SBS≤50，初始化与变异后均执行修正，确保不超配。
- 选择/交叉/变异：种群 150、代数 300、精英保留 60、变异率 0.3；对接入与资源分别交叉与变异，并在每次变异/交叉后做资源修正。

2) 功率控制：凸优化（SLSQP）
- 决策变量：4 个基站功率（dBm），满足各自上下界约束。
- 目标：最大化加权 QoS（以负号最小化）。在目标计算中额外统计各基站平均信道增益，若偏低则对该基站功率做小幅正向修正，以提升弱覆盖区用户体验。
- 初值：MBS/SBS = [30, 20, 20, 20] dBm；优化后常见解接近上界 [40, 30, 30, 30] dBm，以对抗衰落与干扰。

3) 性能评估
- 逐时隙求最优 `(接入, 资源)`，再优化功率；随后计算各用户 SINR、速率与 QoS，汇总：总 QoS、三类业务的平均 QoS。结果持续写入 `q4/results.csv`。

### 关键结果（来自 `q4/results.csv`）

- 总 QoS（0–900ms）：约 22.17 – 28.19；最佳出现在 300ms（28.19）。
- URLLC 平均 QoS：各时隙稳定在 ≈ 0.95（时延严格控制与优先保障）。
- eMBB 平均 QoS：约 0.16 – 0.43，受资源占用与干扰影响较为明显。
- mMTC 平均 QoS：约 0.27 – 0.40，符合“低带宽、重连接数”的设计预期。

结合控制台输出与优化结果，功率最优常达 `[40, 30, 30, 30]` dBm；资源利用率常为 `MBS=100/100`、各 `SBS=50/50`，表明在当前参数与数据分布下，满负载利用可获得较优 QoS。

### 运行结果描述（来自 `q4/运行结果.txt`）

- 代表性时隙记录（与 900ms 时刻一致）：
  - 总用户服务质量：26.6640
  - URLLC 平均 QoS：0.9500
  - eMBB 平均 QoS：0.1591
  - mMTC 平均 QoS：0.3575
- 接入决策（节选）：用户在 4 个基站间分布接入，呈现“URLLC 更偏向信道/负载较优的小区、eMBB 在资源充足的小区集中”的特征。
- 功率控制（dBm）：[40, 30, 30, 30]，达到各基站功率上限，有利于抵消衰落与干扰。
- 资源分配统计：
  - MBS_1：100/100 资源块
  - SBS_1：50/50 资源块
  - SBS_2：50/50 资源块
  - SBS_3：50/50 资源块

以上与 `q4/results.csv` 的时序统计一致：URLLC 保持稳定高 QoS；eMBB 受干扰与资源竞争影响相对偏低；mMTC 随连接占用与 RB 分配在 0.27–0.40 区间波动。

### 方法优势与局限

### 结果评估与解读

- 稳定性：URLLC 平均 QoS 长期稳定在 ≈0.95，说明队列建模与优先级策略有效，且功率/资源策略对低时延业务有持续保障能力。
- 吞吐性：eMBB 平均 QoS 在 0.16–0.43，受干扰和资源切分影响较大，提示需要更强的跨小区干扰管理与带宽倾斜策略来提升峰值与平均吞吐。
- 覆盖性：功率优化趋向上界，意味着在既有大/小尺度衰落与干扰环境下，提升覆盖的主要手段是高功率广播；后续可通过频谱复用优化与干扰协调取得更优“低功率、低干扰”的折中。
- 资源利用：MBS/SBS 基本满载，证明 GA 的资源修正约束有效；但也反映在高负载下，mMTC 与 eMBB 的竞争需更精细的切片或最小保障约束。
- 整体性：总 QoS 在 22.17–28.19 波动，峰值出现在 300ms，与当时的信道/任务负载较为匹配；说明该混合优化能自适应不同时间片的环境差异。

- 优势：
  - 通过 GA 全局搜索离散接入/资源方案，结合凸优化细化连续功率控制，适配“离散+连续”的混合变量结构。
  - 引入业务差异化 QoS 与权重，提升 URLLC 与 eMBB 的服务保障。
  - 干扰协调因子减轻强干扰场景的 QoS 损失。

- 局限与改进方向：
  - 干扰建模仅在“异站同用户”场景生效，可进一步扩展到同频异用户的跨小区干扰耦合。
  - eMBB QoS 偏低，建议：
    1) 提升 eMBB 最大可分配 RB 或引入切片配额；
    2) 在 GA 目标中引入类型平衡/最小保障约束；
    3) 在功率目标中显式加入跨小区干扰惩罚，或联合调度同频资源以降低干扰重叠概率。
  - 目标函数中对弱覆盖基站的功率“内循环修正”虽有效，但会改变可微性/凸性假设，可考虑将其改为外层启发式或加入正则项以保证优化一致性。

### 复现实验与文件

- 运行环境与依赖：见 `requirements.txt`；Windows 路径常量已在脚本顶部设定。
- 入口：直接运行 `q4/q4_solution.py`。
- 输出：指标写入 `q4/results.csv`，控制台给出每时隙的总 QoS、各类 QoS 均值、接入决策与功率向量，以及各基站资源使用统计。

上述方案在附件 4 数据集上实现了对 URLLC 的稳定保障，兼顾 mMTC 的连接性与 eMBB 的吞吐需求，在多目标、多约束的复杂环境下给出了可复现、可扩展的联合优化框架。